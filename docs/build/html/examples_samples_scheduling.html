

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Samples scheduling &mdash; mlmc 1.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Quantity tutorial" href="examples_quantity.html" />
    <link rel="prev" title="Sampler creation" href="examples_sampler_creation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="contents.html" class="icon icon-home"> mlmc
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">MLMC</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#installation">Installation</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="examples_sampler_creation.html">Sampler creation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Samples scheduling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#prescribe-the-exact-number-of-samples">1. Prescribe the exact number of samples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prescribe-a-target-variance">2. Prescribe a target variance</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="examples_quantity.html">Quantity tutorial</a><ul>
<li class="toctree-l3"><a class="reference internal" href="examples_quantity.html#mean-estimates">Mean estimates</a></li>
<li class="toctree-l3"><a class="reference internal" href="examples_quantity.html#estimate-moments-and-covariance-matrix">Estimate moments and covariance matrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="examples_quantity.html#quantity-selection">Quantity selection</a></li>
<li class="toctree-l3"><a class="reference internal" href="examples_quantity.html#binary-operations">Binary operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="examples_quantity.html#numpy-universal-functions">NumPy universal functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="examples_quantity.html#quantity-selection-by-conditions">Quantity selection by conditions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="examples_postprocessing.html">Results postprocessing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="examples_postprocessing.html#probability-density-function-approximation">Probability density function approximation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mlmc.html">MLMC package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="mlmc.html#subpackages">Subpackages</a></li>
<li class="toctree-l2"><a class="reference internal" href="mlmc.html#classes">Classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mlmc.html#sampler">Sampler</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.html#samplingpool">SamplingPool</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.html#samplingpoolpbs">SamplingPoolPBS</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.html#samplestorage">SampleStorage</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.html#samplestoragehdf">SampleStorageHDF</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.html#estimate">Estimate</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.html#moments">Moments</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.html#levelsimulation">LevelSimulation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mlmc.plot.html">mlmc.plot</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mlmc.plot.html#submodules">Submodules</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.plot.html#module-mlmc.plot.plots">mlmc.plot.plots module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.plot.html#module-mlmc.plot.violinplot">mlmc.plot.violinplot module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.plot.html#module-0">Module contents</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mlmc.quantity.html">mlmc.quantity</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mlmc.quantity.html#submodules">Submodules</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.quantity.html#module-mlmc.quantity.quantity">mlmc.quantity.quantity module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.quantity.html#module-mlmc.quantity.quantity_estimate">mlmc.quantity.quantity_estimate module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.quantity.html#module-mlmc.quantity.quantity_spec">mlmc.quantity.quantity_spec module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.quantity.html#module-mlmc.quantity.quantity_types">mlmc.quantity.quantity_types module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.quantity.html#module-0">Module contents</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mlmc.random.html">mlmc.random</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mlmc.random.html#submodules">Submodules</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.random.html#module-mlmc.random.correlated_field">mlmc.random.correlated_field module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.random.html#mlmc-random-frac-geom-module">mlmc.random.frac_geom module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.random.html#mlmc-random-gstools-wrapper-module">mlmc.random.gstools_wrapper module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.random.html#module-0">Module contents</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mlmc.sim.html">mlmc.sim</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mlmc.sim.html#submodules">Submodules</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.sim.html#module-mlmc.sim.simulation">mlmc.sim.simulation module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.sim.html#module-mlmc.sim.synth_simulation">mlmc.sim.synth_simulation module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.sim.html#module-0">Module contents</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mlmc.tool.html">mlmc.tool</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mlmc.tool.html#submodules">Submodules</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.tool.html#mlmc-tool-context-statprof-module">mlmc.tool.context_statprof module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.tool.html#module-mlmc.tool.distribution">mlmc.tool.distribution module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.tool.html#module-mlmc.tool.flow_mc">mlmc.tool.flow_mc module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.tool.html#module-mlmc.tool.gmsh_io">mlmc.tool.gmsh_io module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.tool.html#module-mlmc.tool.hdf5">mlmc.tool.hdf5 module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.tool.html#module-mlmc.tool.pbs_job">mlmc.tool.pbs_job module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.tool.html#module-mlmc.tool.process_base">mlmc.tool.process_base module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.tool.html#module-mlmc.tool.simple_distribution">mlmc.tool.simple_distribution module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.tool.html#module-mlmc.tool.stats_tests">mlmc.tool.stats_tests module</a></li>
<li class="toctree-l3"><a class="reference internal" href="mlmc.tool.html#module-0">Module contents</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="contents.html">mlmc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="contents.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="examples.html">Tutorials</a> &raquo;</li>
        
      <li>Samples scheduling</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/examples_samples_scheduling.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
        <a href="examples_quantity.html" class="btn btn-neutral float-right" title="Quantity tutorial" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
      
      
        <a href="examples_sampler_creation.html" class="btn btn-neutral float-left" title="Sampler creation" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="samples-scheduling">
<span id="examples-samples-scheduling"></span><h1>Samples scheduling<a class="headerlink" href="#samples-scheduling" title="Permalink to this headline">¶</a></h1>
<p>Once you create a sampler you can schedule samples.</p>
<div class="section" id="prescribe-the-exact-number-of-samples">
<h2>1. Prescribe the exact number of samples<a class="headerlink" href="#prescribe-the-exact-number-of-samples" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_samples</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
<span class="n">sampler</span><span class="o">.</span><span class="n">set_initial_n_samples</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
</pre></div>
</div>
<p>Schedule set samples.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">sampler</span><span class="o">.</span><span class="n">schedule_samples</span><span class="p">()</span>
</pre></div>
</div>
<p>You can wait until all samples are finished.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">while</span> <span class="n">running</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">running</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">running</span> <span class="o">+=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">ask_sampling_pool_for_samples</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="prescribe-a-target-variance">
<h2>2. Prescribe a target variance<a class="headerlink" href="#prescribe-a-target-variance" title="Permalink to this headline">¶</a></h2>
<p>Set target variance and number of random variable moments that must meet this variance.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_var</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">n_moments</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
<p>The first phase is the same as the first approach, but the initial samples are automatically determined
as a sequence from 100 samples at the coarsest level to 10 samples at the finest level.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">sampler</span><span class="o">.</span><span class="n">set_initial_n_samples</span><span class="p">()</span>
<span class="n">sampler</span><span class="o">.</span><span class="n">schedule_samples</span><span class="p">()</span>
<span class="n">running</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">while</span> <span class="n">running</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">running</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">running</span> <span class="o">+=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">ask_sampling_pool_for_samples</span><span class="p">()</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="mlmc.quantity.html#mlmc.quantity.quantity.Quantity" title="mlmc.quantity.quantity.Quantity"><code class="xref py py-class docutils literal notranslate"><span class="pre">mlmc.quantity.quantity.Quantity</span></code></a> instance is created, for details see <a class="reference internal" href="examples_quantity.html#examples-quantity"><span class="std std-ref">Quantity tutorial</span></a></p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">root_quantity</span> <span class="o">=</span> <span class="n">mlmc</span><span class="o">.</span><span class="n">make_root_quantity</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">sampler</span><span class="o">.</span><span class="n">sample_storage</span><span class="p">,</span>
                               <span class="n">q_specs</span><span class="o">=</span><span class="n">sampler</span><span class="o">.</span><span class="n">sample_storage</span><span class="o">.</span><span class="n">load_result_format</span><span class="p">())</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">root_quantity</span></code> contains the structure of sample results and also allows access to their values.</p>
<p>In order to estimate moment values including variance, moment functions class (in this case Legendre polynomials) instance
and <a class="reference internal" href="generated/mlmc.estimator.Estimate.html#mlmc.estimator.Estimate" title="mlmc.estimator.Estimate"><code class="xref py py-class docutils literal notranslate"><span class="pre">mlmc.estimator.Estimate</span></code></a> instance are created.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">true_domain</span> <span class="o">=</span> <span class="n">mlmc</span><span class="o">.</span><span class="n">Estimate</span><span class="o">.</span><span class="n">estimate_domain</span><span class="p">(</span><span class="n">root_quantity</span><span class="p">,</span> <span class="n">sample_storage</span><span class="p">)</span>
<span class="n">moments_fn</span> <span class="o">=</span> <span class="n">mlmc</span><span class="o">.</span><span class="n">Legendre</span><span class="p">(</span><span class="n">n_moments</span><span class="p">,</span> <span class="n">true_domain</span><span class="p">)</span>

<span class="n">estimate_obj</span> <span class="o">=</span> <span class="n">mlmc</span><span class="o">.</span><span class="n">Estimate</span><span class="p">(</span><span class="n">root_quantity</span><span class="p">,</span> <span class="n">sample_storage</span><span class="o">=</span><span class="n">sampler</span><span class="o">.</span><span class="n">sample_storage</span><span class="p">,</span>
                                       <span class="n">moments_fn</span><span class="o">=</span><span class="n">moments_fn</span><span class="p">)</span>
</pre></div>
</div>
<p>At first, the variance of moments and average execution time per sample at each level are estimated from already finished samples.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">variances</span><span class="p">,</span> <span class="n">n_ops</span> <span class="o">=</span> <span class="n">estimate_obj</span><span class="o">.</span><span class="n">estimate_diff_vars_regression</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">n_finished_samples</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, an initial estimate of the number of MLMC samples that should meet prescribed target variance is conducted.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlmc.estimator</span> <span class="kn">import</span> <span class="n">estimate_n_samples_for_target_variance</span>
<span class="n">n_estimated</span> <span class="o">=</span> <span class="n">estimate_n_samples_for_target_variance</span><span class="p">(</span><span class="n">target_var</span><span class="p">,</span> <span class="n">variances</span><span class="p">,</span> <span class="n">n_ops</span><span class="p">,</span>
                                                     <span class="n">n_levels</span><span class="o">=</span><span class="n">sampler</span><span class="o">.</span><span class="n">n_levels</span><span class="p">)</span>
</pre></div>
</div>
<p>Now it is time for our sampling algorithm that gradually schedules samples and refines the total number of samples
until the number of estimated samples is greater than the number of scheduled samples.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="ow">not</span> <span class="n">sampler</span><span class="o">.</span><span class="n">process_adding_samples</span><span class="p">(</span><span class="n">n_estimated</span><span class="p">):</span>
    <span class="c1"># New estimation according to already finished samples</span>
    <span class="n">variances</span><span class="p">,</span> <span class="n">n_ops</span> <span class="o">=</span> <span class="n">estimate_obj</span><span class="o">.</span><span class="n">estimate_diff_vars_regression</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">_n_scheduled_samples</span><span class="p">)</span>
    <span class="n">n_estimated</span> <span class="o">=</span> <span class="n">estimate_n_samples_for_target_variance</span><span class="p">(</span><span class="n">target_var</span><span class="p">,</span> <span class="n">variances</span><span class="p">,</span> <span class="n">n_ops</span><span class="p">,</span>
                                                         <span class="n">n_levels</span><span class="o">=</span><span class="n">sampler</span><span class="o">.</span><span class="n">n_levels</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, wait until all samples are finished.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">while</span> <span class="n">running</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">running</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">running</span> <span class="o">+=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">ask_sampling_pool_for_samples</span><span class="p">()</span>
</pre></div>
</div>
<p>Since our sampling algorithm determines the number of samples according to moment variances,
the type of moment functions (Legendre by default) might affect total number of MLMC samples.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, Jan Březina, Martin Špetlík.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>