
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mlmc.plot.plots &#8212; MLMC daf documentation</title>
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for mlmc.plot.plots</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">st</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interpolate</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>

<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">22</span><span class="p">})</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="k">import</span> <span class="n">Patch</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>


<div class="viewcode-block" id="create_color_bar"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.create_color_bar">[docs]</a><span class="k">def</span> <span class="nf">create_color_bar</span><span class="p">(</span><span class="nb">range</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create colorbar for a variable with given range and add it to given axes.</span>
<span class="sd">    :param range: single value as high bound or tuple (low bound, high bound)</span>
<span class="sd">    :param label: Label of the colorbar.</span>
<span class="sd">    :param ax:</span>
<span class="sd">    :return: Function to map values to colors. (normalize + cmap)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create colorbar</span>
    <span class="n">colormap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_ncar</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">min_r</span><span class="p">,</span> <span class="n">max_r</span> <span class="o">=</span> <span class="nb">range</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">min_r</span><span class="p">,</span> <span class="n">max_r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">range</span>
    <span class="n">normalize</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">min_r</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">max_r</span><span class="p">)</span>
    <span class="n">scalar_mappable</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">colormap</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">max_r</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">cb_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_r</span><span class="p">,</span> <span class="n">max_r</span><span class="p">)</span>
        <span class="c1">#ticks = np.linspace(min_r, int(size / 10) * 10, 9)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cb_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_r</span><span class="p">,</span> <span class="n">max_r</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="c1">#ticks = np.linspace(min_r, int(size / 10) * 10, 9)</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">scalar_mappable</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">cb_values</span><span class="p">)</span>
    <span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scalar_mappable</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">ticks</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">colormap</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">v</span><span class="p">))</span></div>


<div class="viewcode-block" id="moments_subset"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.moments_subset">[docs]</a><span class="k">def</span> <span class="nf">moments_subset</span><span class="p">(</span><span class="n">n_moments</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return subset of range(n_moments) for ploting.</span>
<span class="sd">    :param n_moments: Actual number of moments.</span>
<span class="sd">    :param moments: Type of subset:</span>
<span class="sd">        None - all moments</span>
<span class="sd">        int - size of subset, formed by geometrical sequence</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">moments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subset</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_moments</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">moments</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span>
        <span class="n">subset</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">geomspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_moments</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">moments</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># make indices unique by increasing</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)):</span>
            <span class="n">subset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">subset</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">subset</span></div>


<span class="k">def</span> <span class="nf">_show_and_save</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal function to show the figure and/or save it into a file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">title</span>
        <span class="k">if</span> <span class="n">file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">!=</span> <span class="s2">&quot;pdf&quot;</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>


<div class="viewcode-block" id="make_monotone"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.make_monotone">[docs]</a><span class="k">def</span> <span class="nf">make_monotone</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>

    <span class="n">sX</span><span class="p">,</span> <span class="n">iX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y</span><span class="p">)[</span><span class="n">iX</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sX</span><span class="p">,</span> <span class="n">sY</span></div>


<div class="viewcode-block" id="Distribution"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Distribution">[docs]</a><span class="k">class</span> <span class="nc">Distribution</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    mlmc.plot.Distribution</span>

<span class="sd">    Class for plotting distribution approximation: PDF and CDF (optional)</span>
<span class="sd">    Provides methods to: add more plots, add exact PDF, add ECDF/histogram from single level MC</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exact_distr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">quantity_name</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="n">legend_title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">log_density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cdf_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log_x</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">error_plot</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot configuration</span>
<span class="sd">        :param exact_distr:  Optional exact domain (for adding to plot and computing error)</span>
<span class="sd">        :param title: Figure title.</span>
<span class="sd">        :param quantity_name: Quantity for X axis label.</span>
<span class="sd">        :param log_density: Plot logarithm of density value.</span>
<span class="sd">        :param cdf_plot: Plot CDF as well (default)</span>
<span class="sd">        :param log_x: Use logarithmic scale for X axis.</span>
<span class="sd">        :param error_plot: None, &#39;diff&#39;, &#39;kl. Plot error of pdf using either difference or</span>
<span class="sd">        integrand of KL divergence: exact_pdf * log(exact_pdf / approx_pdf).</span>
<span class="sd">        Simple difference is used for CDF for both options.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exact_distr</span> <span class="o">=</span> <span class="n">exact_distr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_density</span> <span class="o">=</span> <span class="n">log_density</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_x</span> <span class="o">=</span> <span class="n">log_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error_plot</span> <span class="o">=</span> <span class="n">error_plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_domain</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_legend_title</span> <span class="o">=</span> <span class="n">legend_title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_matrix</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_plot</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">cdf_plot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fig_cdf</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_cdf</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fig_cdf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax_cdf</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">x_axis_label</span> <span class="o">=</span> <span class="n">quantity_name</span>

        <span class="c1"># PDF axes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;PDF approximations&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;probability density&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_axis_label</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_x</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">x_axis_label</span> <span class="o">=</span> <span class="s2">&quot;log &quot;</span> <span class="o">+</span> <span class="n">x_axis_label</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_density</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="c1"># CDF axes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax_cdf</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;CDF approximations&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax_cdf</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;probability&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax_cdf</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_axis_label</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_x</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_cdf</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">error_plot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">pdf_err_title</span> <span class="o">=</span> <span class="s2">&quot;error - dashed&quot;</span>
            <span class="k">if</span> <span class="n">error_plot</span> <span class="o">==</span> <span class="s1">&#39;kl&#39;</span><span class="p">:</span>
                <span class="n">pdf_err_title</span> <span class="o">=</span> <span class="s2">&quot;KL-error - dashed&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf_err</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">pdf_err_title</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_cdf_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax_cdf</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_cdf</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_cdf</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax_cdf_err</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;error - dashed&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf_err</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_cdf_err</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Distribution.add_raw_samples"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Distribution.add_raw_samples">[docs]</a>    <span class="k">def</span> <span class="nf">add_raw_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add histogram and ecdf for raw samples.</span>
<span class="sd">        :param samples:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Histogram</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">samples</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjust_domain</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">N</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;samples&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span></div>

        <span class="c1"># # Ecdf</span>
        <span class="c1"># X = np.sort(samples)</span>
        <span class="c1"># Y = (np.arange(len(X)) + 0.5) / float(len(X))</span>
        <span class="c1"># X, Y = make_monotone(X, Y)</span>
        <span class="c1"># self.ax_cdf.plot(X, Y, &#39;red&#39;)</span>
        <span class="c1">#</span>
        <span class="c1"># # PDF approx as derivative of Bspline CDF approx</span>
        <span class="c1"># size_8 = int(N / 8)</span>
        <span class="c1"># w = np.ones_like(X)</span>
        <span class="c1"># w[:size_8] = 1 / (Y[:size_8])</span>
        <span class="c1"># w[N - size_8:] = 1 / (1 - Y[N - size_8:])</span>
        <span class="c1"># spl = interpolate.UnivariateSpline(X, Y, w, k=3, s=1)</span>
        <span class="c1"># sX = np.linspace(domain[0], domain[1], 1000)</span>
        <span class="c1"># self.ax_pdf.plot(sX, spl.derivative()(sX), color=&#39;red&#39;, alpha=0.4)</span>

<div class="viewcode-block" id="Distribution.add_distribution"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Distribution.add_distribution">[docs]</a>    <span class="k">def</span> <span class="nf">add_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distr_object</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add plot for distribution &#39;distr_object&#39; with given label.</span>
<span class="sd">        :param distr_object: Instance of Distribution, we use methods: density, cdf and attribute domain</span>
<span class="sd">        :param label: string label for legend</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;size </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">distr_object</span><span class="o">.</span><span class="n">moments_fn</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">distr_object</span><span class="o">.</span><span class="n">domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjust_domain</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
        <span class="n">d_size</span> <span class="o">=</span> <span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">slack</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0.05</span>
        <span class="n">extended_domain</span> <span class="o">=</span> <span class="p">(</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">slack</span> <span class="o">*</span> <span class="n">d_size</span><span class="p">,</span> <span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">slack</span> <span class="o">*</span> <span class="n">d_size</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;C</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i_plot</span><span class="p">)</span>

        <span class="n">plots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Y_pdf</span> <span class="o">=</span> <span class="n">distr_object</span><span class="o">.</span><span class="n">density</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y_pdf</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_borders</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>

        <span class="n">Y_cdf</span> <span class="o">=</span> <span class="n">distr_object</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax_cdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y_cdf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_borders</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax_cdf</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_plot</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exact_distr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_plot</span> <span class="o">==</span> <span class="s1">&#39;kl&#39;</span><span class="p">:</span>
                <span class="n">exact_pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exact_distr</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                <span class="n">eY_pdf</span> <span class="o">=</span> <span class="n">exact_pdf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">exact_pdf</span> <span class="o">/</span> <span class="n">Y_pdf</span><span class="p">)</span> <span class="o">-</span> <span class="n">exact_pdf</span> <span class="o">+</span> <span class="n">Y_pdf</span>
                <span class="c1">#eY_pdf = exact_pdf / Y_pdf #* np.log(exact_pdf / Y_pdf) / Y_pdf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eY_pdf</span> <span class="o">=</span> <span class="n">Y_pdf</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exact_distr</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf_err</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">eY_pdf</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">eY_cdf</span> <span class="o">=</span> <span class="n">Y_cdf</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exact_distr</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_cdf_err</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">eY_cdf</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">i_plot</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Distribution.show"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Distribution.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set colors according to the number of added plots.</span>
<span class="sd">        Set domain from all plots.</span>
<span class="sd">        Plot exact distribution.</span>
<span class="sd">        show, possibly save to file.</span>
<span class="sd">        :param file: None, or filename, default name is same as plot title.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_exact_distr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_legend_title</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">_show_and_save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_title</span><span class="p">)</span></div>

<div class="viewcode-block" id="Distribution.reset"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Distribution.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_domain</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_plot_borders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add vertical lines to the plot for endpoints of the &#39;domain&#39;.</span>
<span class="sd">        :return: Pair of line objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">domain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain</span>
        <span class="n">l1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">]</span>

<div class="viewcode-block" id="Distribution.adjust_domain"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Distribution.adjust_domain">[docs]</a>    <span class="k">def</span> <span class="nf">adjust_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enlarge common domain by given bounds.</span>
<span class="sd">        :param value: [lower_bound, upper_bound]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_domain</span> <span class="o">=</span> <span class="n">domain</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_domain</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span></div>

    <span class="k">def</span> <span class="nf">_add_exact_distr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot exact PDF and CDF.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exact_distr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># with np.printoptions(precision=2):</span>
        <span class="c1">#    lab = str(np.array(self._domain))</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exact_distr</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax_pdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">)</span>

        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exact_distr</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax_cdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        X values grid for given domain. Optionally use the log scale.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">domain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_x</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">geomspace</span><span class="p">(</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span></div>


<div class="viewcode-block" id="Eigenvalues"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Eigenvalues">[docs]</a><span class="k">class</span> <span class="nc">Eigenvalues</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot of eigenvalues (of the covariance matrix), several sets of eigenvalues can be added</span>
<span class="sd">    together with error bars and cut-tresholds.</span>
<span class="sd">    Colors are chosen automatically. Slight X shift is used to avoid point overlapping.</span>
<span class="sd">    For log Y scale only positive values are plotted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Eigenvalues&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ylim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_y</span> <span class="o">=</span> <span class="n">log_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_plot</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="c1"># index of eignevalues dataset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_y</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Eigenvalues.add_values"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Eigenvalues.add_values">[docs]</a>    <span class="k">def</span> <span class="nf">add_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add set of eigenvalues into the plot.</span>
<span class="sd">        :param values: array (n,); eigen values in increasing or decreasing ordred, automatically flipped to decreasing.</span>
<span class="sd">        :param errors: array (n,); corresponding std errors</span>
<span class="sd">        :param threshold: horizontal line marking noise level or cut-off eigen value</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">errors</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">errors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">threshold</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_y</span><span class="p">:</span>
            <span class="c1"># plot only positive values</span>
            <span class="n">i_last_positive</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[:</span><span class="n">i_last_positive</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adjust_ylim</span><span class="p">(</span> <span class="p">(</span><span class="n">a</span> <span class="o">/</span> <span class="p">((</span><span class="n">b</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mf">0.05</span><span class="p">),</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mf">0.05</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adjust_ylim</span><span class="p">(</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">),</span> <span class="n">b</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">))</span> <span class="p">)</span>

        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;C</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i_plot</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_plot</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="k">if</span> <span class="n">errors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">errors</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">capthick</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_plot</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Eigenvalues.add_linear_fit"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Eigenvalues.add_linear_fit">[docs]</a>    <span class="k">def</span> <span class="nf">add_linear_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Eigenvalues.show"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Eigenvalues.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show the plot or save to file.</span>
<span class="sd">        :param file: filename base, None for show.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Noise level&quot;</span><span class="p">)</span>
        <span class="n">_show_and_save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span></div>

<div class="viewcode-block" id="Eigenvalues.adjust_ylim"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Eigenvalues.adjust_ylim">[docs]</a>    <span class="k">def</span> <span class="nf">adjust_ylim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ylim</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enlarge common domain by given bounds.</span>
<span class="sd">        :param value: [lower_bound, upper_bound]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ylim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ylim</span> <span class="o">=</span> <span class="n">ylim</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ylim</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span></div></div>


<div class="viewcode-block" id="moments"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.moments">[docs]</a><span class="k">def</span> <span class="nf">moments</span><span class="p">(</span><span class="n">moments_fn</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot moment functions.</span>
<span class="sd">    :param moments_fn:</span>
<span class="sd">    :param size:</span>
<span class="sd">    :param title:</span>
<span class="sd">    :param file:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">moments_fn</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">create_color_bar</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s1">&#39;moments&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
    <span class="n">n_pt</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">moments_fn</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moments_fn</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_pt</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">moments_fn</span><span class="o">.</span><span class="n">_eval_all</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
    <span class="n">central_band</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">n_pt</span><span class="o">*</span><span class="mf">0.1</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">n_pt</span><span class="o">*</span><span class="mf">0.9</span><span class="p">),</span> <span class="p">:]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">central_band</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">central_band</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">_show_and_save</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span></div>


<div class="viewcode-block" id="VarianceBreakdown"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.VarianceBreakdown">[docs]</a><span class="k">class</span> <span class="nc">VarianceBreakdown</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot total variance average over moments and variances of individual moments,</span>
<span class="sd">    Brake down to contribution of individual levels and optionally comparison to the reference level variances using</span>
<span class="sd">    error bars for the (signed) difference: ref_level_vars - level_vars</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param moments: Size or type of moments subset, see moments_subset function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span>  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Variance brakedown&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_shift</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_moments</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subset_type</span> <span class="o">=</span> <span class="n">moments</span>

<div class="viewcode-block" id="VarianceBreakdown.add_variances"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.VarianceBreakdown.add_variances">[docs]</a>    <span class="k">def</span> <span class="nf">add_variances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level_vars</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">ref_level_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add plot of variances for single MLMC instance.</span>

<span class="sd">        :param level_vars: Array (n_levels, n_moments) of level variances.</span>
<span class="sd">        :param n_samples: Array (n_levels,) of numberf of samples on levels</span>
<span class="sd">        :param ref_level_vars: reference level vars (e.g. from bootstrapping)</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_levels</span><span class="p">,</span> <span class="n">n_moments</span> <span class="o">=</span> <span class="n">level_vars</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">assert</span> <span class="n">n_samples</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">n_levels</span><span class="p">,</span> <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_moments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_moments</span> <span class="o">=</span> <span class="n">n_moments</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moments_subset</span> <span class="o">=</span> <span class="n">moments_subset</span><span class="p">(</span><span class="n">n_moments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subset_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_moments</span> <span class="o">==</span> <span class="n">n_moments</span>

        <span class="n">level_vars</span> <span class="o">=</span> <span class="n">level_vars</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">moments_subset</span><span class="p">]</span>
        <span class="n">n_levels</span><span class="p">,</span> <span class="n">n_moments</span> <span class="o">=</span> <span class="n">level_vars</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">width</span><span class="o">=</span><span class="mf">0.1</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_shift</span> <span class="o">+</span> <span class="p">(</span><span class="n">width</span><span class="o">*</span><span class="mf">1.1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_moments</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_shift</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">X_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">moments_subset</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_labels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">X_labels</span><span class="p">)</span>
        <span class="c1">#plots = []</span>
        <span class="n">sum_Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_moments</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">yerr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">total_Y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">level_vars</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">n_samples</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">il</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_levels</span><span class="p">)):</span>
            <span class="nb">vars</span> <span class="o">=</span> <span class="n">level_vars</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">vars</span><span class="p">)],</span> <span class="nb">vars</span><span class="p">))</span>
            <span class="n">Y</span> <span class="o">/=</span> <span class="n">n_samples</span><span class="p">[</span><span class="n">il</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">ref_level_vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ref_vars</span> <span class="o">=</span> <span class="n">ref_level_vars</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">moments_subset</span><span class="p">]</span>
                <span class="n">ref_Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ref_vars</span><span class="p">)],</span> <span class="n">ref_vars</span><span class="p">))</span>
                <span class="n">ref_Y</span> <span class="o">/=</span> <span class="n">n_samples</span><span class="p">[</span><span class="n">il</span><span class="p">]</span>
                <span class="n">diff_Y</span> <span class="o">=</span> <span class="n">ref_Y</span> <span class="o">-</span> <span class="n">Y</span>
                <span class="n">yerr_lower_lim</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">diff_Y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">yerr_upper_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">diff_Y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">yerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">yerr_lower_lim</span><span class="p">,</span> <span class="n">yerr_upper_lim</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">level_col</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab20</span><span class="p">(</span><span class="n">il</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">sum_Y</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">level_col</span><span class="p">)</span>
            <span class="n">level_label</span> <span class="o">=</span> <span class="s2">&quot;L</span><span class="si">{}</span><span class="s2"> </span><span class="si">{:5}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">[</span><span class="n">il</span><span class="p">])</span>
            <span class="n">aX</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">aY</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sum_Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tY</span> <span class="o">=</span> <span class="n">total_Y0</span> <span class="o">*</span> <span class="p">((</span><span class="n">n_levels</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">il</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_levels</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">level_label</span><span class="p">,</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">aX</span><span class="p">,</span> <span class="n">aY</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="n">tY</span><span class="p">),</span>
                <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">level_col</span><span class="p">),</span>
                <span class="n">textcoords</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;offset pixels&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="n">sum_Y</span> <span class="o">+=</span> <span class="n">Y</span></div>


<div class="viewcode-block" id="VarianceBreakdown.show"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.VarianceBreakdown.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show the plot or save to file.</span>
<span class="sd">        :param filename: filename base, None for show.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;moments&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_list</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_labels</span><span class="p">)</span>
        <span class="n">_show_and_save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Variance"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Variance">[docs]</a><span class="k">class</span> <span class="nc">Variance</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot level variances, i.e. Var X^l as a function of the mesh step.</span>
<span class="sd">    Selected moments are plotted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param moments: Size or type of moments subset, see moments_subset function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Level variances&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$h$ - mesh step&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Var $X^h$&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_moments</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subset_type</span> <span class="o">=</span> <span class="n">moments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_step</span> <span class="o">=</span> <span class="mf">1e300</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Variance.add_level_variances"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Variance.add_level_variances">[docs]</a>    <span class="k">def</span> <span class="nf">add_level_variances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">variances</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add variances for single MLMC instance.</span>
<span class="sd">        :param steps, variances : as returned by Estimate.estimate_level_vars</span>
<span class="sd">        :param n_levels:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_levels</span><span class="p">,</span> <span class="n">n_moments</span> <span class="o">=</span> <span class="n">variances</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_moments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_moments</span> <span class="o">=</span> <span class="n">n_moments</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moments_subset</span> <span class="o">=</span> <span class="n">moments_subset</span><span class="p">(</span><span class="n">n_moments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subset_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_moments</span> <span class="o">==</span> <span class="n">n_moments</span>

        <span class="n">variances</span> <span class="o">=</span> <span class="n">variances</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">moments_subset</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_step</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_step</span><span class="p">,</span> <span class="n">steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_step</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_step</span><span class="p">,</span> <span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="nb">vars</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variances</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">([],</span> <span class="p">[]))</span>
            <span class="n">X</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">steps</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="n">Y</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">vars</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span></div>

<div class="viewcode-block" id="Variance.show"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Variance.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">step_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_step</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_step</span>
        <span class="n">log_scale</span> <span class="o">=</span> <span class="n">step_range</span> <span class="o">**</span> <span class="mf">0.001</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">lognorm</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">log_scale</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab20</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;M</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moments_subset</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
            <span class="n">XX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">rv</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">XX</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="c1">#f = interpolate.interp1d(X, Y, kind=&#39;cubic&#39;)</span>

            <span class="n">XX</span><span class="p">,</span> <span class="n">YY</span> <span class="o">=</span> <span class="n">make_monotone</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

            <span class="c1">#f = interpolate.PchipInterpolator(XX[1:], YY[1:])</span>
            <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">XX</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">spl</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">XX</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">YY</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">m</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="p">))</span>
            <span class="n">xf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">geomspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_step</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">yf</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="n">spl</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="n">yf</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">_show_and_save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BSplots"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.BSplots">[docs]</a><span class="k">class</span> <span class="nc">BSplots</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">bs_n_samples</span><span class="p">,</span> <span class="n">n_moments</span><span class="p">,</span> <span class="n">ref_level_var</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bs_n_samples</span> <span class="o">=</span> <span class="n">bs_n_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_samples</span> <span class="o">=</span> <span class="n">n_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_moments</span> <span class="o">=</span> <span class="n">n_moments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ref_level_var</span> <span class="o">=</span> <span class="n">ref_level_var</span>

<div class="viewcode-block" id="BSplots.set_moments_color_bar"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.BSplots.set_moments_color_bar">[docs]</a>    <span class="k">def</span> <span class="nf">set_moments_color_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create colorbar for a variable with given range and add it to given axes.</span>
<span class="sd">        :param range: single value as high bound or tuple (low bound, high bound)</span>
<span class="sd">        :param label: Label of the colorbar.</span>
<span class="sd">        :param ax:</span>
<span class="sd">        :return: Function to map values to colors. (normalize + cmap)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create colorbar</span>
        <span class="n">colormap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_ncar</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">min_r</span><span class="p">,</span> <span class="n">max_r</span> <span class="o">=</span> <span class="nb">range</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">min_r</span><span class="p">,</span> <span class="n">max_r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">range</span>
        <span class="n">normalize</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">min_r</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">max_r</span><span class="p">)</span>
        <span class="n">scalar_mappable</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">colormap</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">max_r</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">cb_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_r</span><span class="p">,</span> <span class="n">max_r</span><span class="p">)</span>
            <span class="c1"># ticks = np.linspace(min_r, int(size / 10) * 10, 9)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cb_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_r</span><span class="p">,</span> <span class="n">max_r</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="c1"># ticks = np.linspace(min_r, int(size / 10) * 10, 9)</span>
        <span class="n">ticks</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">scalar_mappable</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">cb_values</span><span class="p">)</span>
        <span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scalar_mappable</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">ticks</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">colormap</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">v</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_scatter_level_moment_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">i_moments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scatter plot of given table of data for moments and levels.</span>
<span class="sd">        X coordinate is given by level, and slight shift is applied to distinguish the moments.</span>
<span class="sd">        Moments are colored using self._moments_cmap.</span>
<span class="sd">        :param ax: Axis where to add the scatter.</span>
<span class="sd">        :param values: data to plot, array n_levels x len(i_moments)</span>
<span class="sd">        :param i_moments: Indices of moments to use, all moments grater then 0 are used.</span>
<span class="sd">        :param marker: Scatter marker to use.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moments_cmap</span>
        <span class="k">if</span> <span class="n">i_moments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">i_moments</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_moments</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[:,</span> <span class="n">i_moments</span><span class="p">[:]]</span>
        <span class="n">n_levels</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_moments</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">moments_x_step</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">/</span><span class="n">n_moments</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_moments</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">i_moments</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_levels</span><span class="p">)</span> <span class="o">+</span> <span class="n">moments_x_step</span> <span class="o">*</span> <span class="n">m</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">values</span><span class="p">[:,</span> <span class="n">m</span><span class="p">]</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_levels</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">color</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;var, m=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_moments</span><span class="p">[</span><span class="n">m</span><span class="p">]))</span>

<div class="viewcode-block" id="BSplots.plot_bootstrap_variance_compare"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.BSplots.plot_bootstrap_variance_compare">[docs]</a>    <span class="k">def</span> <span class="nf">plot_bootstrap_variance_compare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot fraction (MLMC var est) / (BS var set) for the total variance and level variances.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">moments_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">moments</span>
        <span class="n">mean</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">l_mean</span><span class="p">,</span> <span class="n">l_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_get_estimates</span><span class="p">(</span><span class="n">moments_fn</span><span class="p">)</span>
        <span class="n">l_var</span> <span class="o">=</span> <span class="n">l_var</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="p">[:</span> <span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">est_variances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">var</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">l_var</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">bs_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_mean_variance</span>
        <span class="n">bs_l_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_level_mean_variance</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">bs_variances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">bs_var</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">bs_l_var</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">fraction</span> <span class="o">=</span> <span class="n">est_variances</span> <span class="o">/</span> <span class="n">bs_variances</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1">#self._scatter_level_moment_data(ax, bs_variances, marker=&#39;.&#39;)</span>
        <span class="c1">#self._scatter_level_moment_data(ax, est_variances, marker=&#39;d&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scatter_level_moment_data</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">fraction</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

        <span class="c1">#ax.legend(loc=6)</span>
        <span class="n">lbls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;L</span><span class="si">{:2d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_levels</span><span class="p">)]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_levels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">lbls</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mf">0.3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">color_bar</span><span class="p">(</span><span class="n">moments_fn</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s1">&#39;moments&#39;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;bs_var_vs_var.pdf&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="BSplots.plot_bs_variances"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.BSplots.plot_bs_variances">[docs]</a>    <span class="k">def</span> <span class="nf">plot_bs_variances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variances</span><span class="p">,</span> <span class="n">y_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">y_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot BS estimate of error of variances of other related quantities.</span>
<span class="sd">        :param variances: Data, shape: (n_levels + 1, n_moments).</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">y_lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_lim</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">variances</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">variances</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]))</span>
        <span class="k">if</span> <span class="n">y_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Error of variance estimates&quot;</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_moments_cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_moments_color_bar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">variances</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;moments&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scatter_level_moment_data</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">variances</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

        <span class="n">lbls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;L</span><span class="si">{:2d}</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsbs</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="p">(</span><span class="n">nsbs</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bs_n_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_samples</span><span class="p">))]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bs_n_samples</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="c1"># number of levels + 1</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">lbls</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_lim</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;bs_var_var.pdf&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="BSplots.plot_bs_var_error_contributions"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.BSplots.plot_bs_var_error_contributions">[docs]</a>    <span class="k">def</span> <span class="nf">plot_bs_var_error_contributions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        MSE of total variance and contribution of individual levels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bs_var_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_var_variance</span><span class="p">[:]</span>
        <span class="n">bs_l_var_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_level_var_variance</span><span class="p">[:,</span> <span class="p">:]</span>
        <span class="n">bs_l_var_var</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_n_samples</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">bs_variances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">bs_var_var</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">bs_l_var_var</span><span class="p">[:,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_bs_variances</span><span class="p">(</span><span class="n">bs_variances</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">y_label</span><span class="o">=</span><span class="s2">&quot;MSE of total variance and contributions from individual levels.&quot;</span><span class="p">,</span>
                               <span class="p">)</span></div>

<div class="viewcode-block" id="BSplots.plot_bs_level_variances_error"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.BSplots.plot_bs_level_variances_error">[docs]</a>    <span class="k">def</span> <span class="nf">plot_bs_level_variances_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot error of estimates of V_l. Scaled as V_l^2 / N_l</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref_level_var</span>

        <span class="n">l_var_var_scale</span> <span class="o">=</span> <span class="n">l_var</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bs_n_samples</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">total_var_var_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">l_var_var_scale</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_n_samples</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>

        <span class="n">bs_var_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_var_variance</span><span class="p">[:]</span>
        <span class="n">bs_var_var</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">/=</span> <span class="n">total_var_var_scale</span>

        <span class="n">bs_l_var_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_level_var_variance</span><span class="p">[:,</span> <span class="p">:]</span>
        <span class="n">bs_l_var_var</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">/=</span> <span class="n">l_var_var_scale</span>

        <span class="n">bs_variances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">bs_var_var</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">bs_l_var_var</span><span class="p">[:,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_bs_variances</span><span class="p">(</span><span class="n">bs_variances</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">y_label</span><span class="o">=</span><span class="s2">&quot;MSE of level variances estimators scaled by $V_l^2/N_l$.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BSplots.plot_bs_var_log_var"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.BSplots.plot_bs_var_log_var">[docs]</a>    <span class="k">def</span> <span class="nf">plot_bs_var_log_var</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that  MSE of log V_l scales as variance of log chi^2_{N-1}, that is approx. 2 / (n_samples-1).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#vv = 1/ self.mlmc._variance_of_variance(self._bs_n_samples)</span>
        <span class="n">vv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_n_samples</span>
        <span class="n">bs_l_var_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_bs_level_var_variance</span><span class="p">[:,</span> <span class="p">:])</span> <span class="o">*</span> <span class="n">vv</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">bs_var_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_var_variance</span><span class="p">[:]</span>  <span class="c1"># - np.log(total_var_var_scale)</span>
        <span class="n">bs_variances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">bs_var_var</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">bs_l_var_var</span><span class="p">[:,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_bs_variances</span><span class="p">(</span><span class="n">bs_variances</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">y_label</span><span class="o">=</span><span class="s2">&quot;BS est. of var. of $\hat V^r$, $\hat V^r_l$ estimators.&quot;</span><span class="p">,</span>
                               <span class="p">)</span><span class="c1">#y_lim=(0.1, 20))</span></div>

    <span class="c1"># def plot_bs_var_reg_var(self):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Test that  MSE of log V_l scales as variance of log chi^2_{N-1}, that is approx. 2 / (n_samples-1).</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     vv = self.mlmc._variance_of_variance(self._bs_n_samples)</span>
    <span class="c1">#     bs_l_var_var = (self._bs_level_var_variance[:, :]) / vv[:, None]</span>
    <span class="c1">#     bs_var_var = self._bs_var_variance[:]  # - np.log(total_var_var_scale)</span>
    <span class="c1">#     bs_variances = np.concatenate((bs_var_var[None, :], bs_l_var_var[:, :]), axis=0)</span>
    <span class="c1">#     self.plot_bs_variances(bs_variances, log=True,</span>
    <span class="c1">#                            y_label=&quot;BS est. of var. of $\hat V^r$, $\hat V^r_l$ estimators.&quot;,</span>
    <span class="c1">#                            y_lim=(0.1, 20))</span>

<div class="viewcode-block" id="BSplots.plot_means_and_vars"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.BSplots.plot_means_and_vars">[docs]</a>    <span class="k">def</span> <span class="nf">plot_means_and_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moments_mean</span><span class="p">,</span> <span class="n">moments_var</span><span class="p">,</span> <span class="n">n_levels</span><span class="p">,</span> <span class="n">exact_moments</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot means with variance whiskers to given axes.</span>
<span class="sd">        :param moments_mean: array, moments mean</span>
<span class="sd">        :param moments_var: array, moments variance</span>
<span class="sd">        :param n_levels: array, number of levels</span>
<span class="sd">        :param exact_moments: array, moments from distribution</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mf">0.3</span>
        <span class="n">default_x</span> <span class="o">=</span> <span class="n">x</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_moments_cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_moments_color_bar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">moments_mean</span><span class="p">),</span> <span class="s2">&quot;moments&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">means</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">moments_mean</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">moments_mean</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exact_moments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">default_x</span><span class="p">,</span> <span class="n">exact_moments</span><span class="p">,</span> <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Exact moments&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">((</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">moments_var</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_moments_cmap</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
                             <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">LMC&quot;</span> <span class="o">%</span> <span class="n">n_levels</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="BSplots.plot_var_regression"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.BSplots.plot_var_regression">[docs]</a>    <span class="k">def</span> <span class="nf">plot_var_regression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">estimator</span><span class="p">,</span> <span class="n">n_levels</span><span class="p">,</span> <span class="n">moments_fn</span><span class="p">,</span> <span class="n">i_moments</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot total and level variances and their regression and errors of regression.</span>
<span class="sd">        :param i_moments: List of moment indices to plot. If it is an int M, the range(M) is used.</span>
<span class="sd">                       If None, self.moments_fn.size is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax_err</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i_moments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">i_moments</span> <span class="o">=</span> <span class="n">moments_fn</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">i_moments</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">i_moments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">i_moments</span><span class="p">))</span>
        <span class="n">i_moments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i_moments</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_moments_cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_moments_color_bar</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="n">moments_fn</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;moments&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">est_diff_vars</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">estimate_diff_vars</span><span class="p">(</span><span class="n">moments_fn</span><span class="p">)</span>
        <span class="n">reg_diff_vars</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">estimate_diff_vars_regression</span><span class="p">(</span><span class="n">moments_fn</span><span class="p">)</span> <span class="c1">#/ self.n_samples[:, None]</span>
        <span class="n">ref_diff_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref_level_var</span> <span class="c1">#/ self.n_samples[:, None]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_scatter_level_moment_data</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span>  <span class="n">ref_diff_vars</span><span class="p">,</span> <span class="n">i_moments</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scatter_level_moment_data</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">est_diff_vars</span><span class="p">,</span> <span class="n">i_moments</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="c1"># add regression curves</span>
        <span class="n">moments_x_step</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_moments</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">i_moments</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moments_cmap</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_levels</span><span class="p">)</span> <span class="o">+</span> <span class="n">moments_x_step</span> <span class="o">*</span> <span class="n">m</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">reg_diff_vars</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="n">m</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">Y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
            <span class="n">ax_err</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[:],</span> <span class="n">reg_diff_vars</span><span class="p">[:,</span> <span class="n">m</span><span class="p">]</span><span class="o">/</span><span class="n">ref_diff_vars</span><span class="p">[:,</span><span class="n">m</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;level variance $V_l$&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;step h_l&quot;</span><span class="p">)</span>

        <span class="n">ax_err</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax_err</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;regresion var. / reference var.&quot;</span><span class="p">)</span>

        <span class="c1">#ax.legend(loc=2)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;level_vars_regression.pdf&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>



<div class="viewcode-block" id="Aux"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Aux">[docs]</a><span class="k">class</span> <span class="nc">Aux</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">_scatter_level_moment_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">i_moments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scatter plot of given table of data for moments and levels.</span>
<span class="sd">        X coordinate is given by level, and slight shift is applied to distinguish the moments.</span>
<span class="sd">        Moments are colored using self._moments_cmap.</span>
<span class="sd">        :param ax: Axis where to add the scatter.</span>
<span class="sd">        :param values: data to plot, array n_levels x len(i_moments)</span>
<span class="sd">        :param i_moments: Indices of moments to use, all moments grater then 0 are used.</span>
<span class="sd">        :param marker: Scatter marker to use.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moments_cmap</span>
        <span class="k">if</span> <span class="n">i_moments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">i_moments</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_moments</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[:,</span> <span class="n">i_moments</span><span class="p">[:]]</span>
        <span class="n">n_levels</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_moments</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">moments_x_step</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">/</span><span class="n">n_moments</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_moments</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">i_moments</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_levels</span><span class="p">)</span> <span class="o">+</span> <span class="n">moments_x_step</span> <span class="o">*</span> <span class="n">m</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">values</span><span class="p">[:,</span> <span class="n">m</span><span class="p">]</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_levels</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">color</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;var, m=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_moments</span><span class="p">[</span><span class="n">m</span><span class="p">]))</span>

<div class="viewcode-block" id="Aux.plot_bootstrap_variance_compare"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Aux.plot_bootstrap_variance_compare">[docs]</a>    <span class="k">def</span> <span class="nf">plot_bootstrap_variance_compare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot fraction (MLMC var est) / (BS var set) for the total variance and level variances.</span>
<span class="sd">        :param moments_fn:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">moments_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">moments</span>
        <span class="n">mean</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">l_mean</span><span class="p">,</span> <span class="n">l_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_get_estimates</span><span class="p">(</span><span class="n">moments_fn</span><span class="p">)</span>
        <span class="n">l_var</span> <span class="o">=</span> <span class="n">l_var</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="p">[:</span> <span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">est_variances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">var</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">l_var</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">bs_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_mean_variance</span>
        <span class="n">bs_l_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_level_mean_variance</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">bs_variances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">bs_var</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">bs_l_var</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">fraction</span> <span class="o">=</span> <span class="n">est_variances</span> <span class="o">/</span> <span class="n">bs_variances</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1">#self._scatter_level_moment_data(ax, bs_variances, marker=&#39;.&#39;)</span>
        <span class="c1">#self._scatter_level_moment_data(ax, est_variances, marker=&#39;d&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scatter_level_moment_data</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">fraction</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

        <span class="c1">#ax.legend(loc=6)</span>
        <span class="n">lbls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;L</span><span class="si">{:2d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_levels</span><span class="p">)]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_levels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">lbls</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mf">0.3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">color_bar</span><span class="p">(</span><span class="n">moments_fn</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s1">&#39;moments&#39;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;bs_var_vs_var.pdf&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Aux.plot_bs_variances"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Aux.plot_bs_variances">[docs]</a>    <span class="k">def</span> <span class="nf">plot_bs_variances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variances</span><span class="p">,</span> <span class="n">y_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">y_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot BS estimate of error of variances of other related quantities.</span>
<span class="sd">        :param variances: Data, shape: (n_levels + 1, n_moments).</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">y_lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_lim</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">variances</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">variances</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]))</span>
        <span class="k">if</span> <span class="n">y_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Error of variance estimates&quot;</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_moments_color_bar</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scatter_level_moment_data</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">variances</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

        <span class="n">lbls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;L</span><span class="si">{:2d}</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsbs</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="p">(</span><span class="n">nsbs</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bs_n_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="p">))]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_levels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">lbls</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_lim</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;bs_var_var.pdf&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Aux.plot_bs_var_error_contributions"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Aux.plot_bs_var_error_contributions">[docs]</a>    <span class="k">def</span> <span class="nf">plot_bs_var_error_contributions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        MSE of total variance and contribution of individual levels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bs_var_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_var_variance</span><span class="p">[:]</span>
        <span class="n">bs_l_var_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_level_var_variance</span><span class="p">[:,</span> <span class="p">:]</span>
        <span class="n">bs_l_var_var</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_n_samples</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">bs_variances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">bs_var_var</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">bs_l_var_var</span><span class="p">[:,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_bs_variances</span><span class="p">(</span><span class="n">bs_variances</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">y_label</span><span class="o">=</span><span class="s2">&quot;MSE of total variance and contributions from individual levels.&quot;</span><span class="p">,</span>
                               <span class="p">)</span></div>

<div class="viewcode-block" id="Aux.plot_bs_level_variances_error"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Aux.plot_bs_level_variances_error">[docs]</a>    <span class="k">def</span> <span class="nf">plot_bs_level_variances_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot error of estimates of V_l. Scaled as V_l^2 / N_l</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref_level_var</span>

        <span class="n">l_var_var_scale</span> <span class="o">=</span> <span class="n">l_var</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bs_n_samples</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">total_var_var_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">l_var_var_scale</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_n_samples</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>

        <span class="n">bs_var_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_var_variance</span><span class="p">[:]</span>
        <span class="n">bs_var_var</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">/=</span> <span class="n">total_var_var_scale</span>

        <span class="n">bs_l_var_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_level_var_variance</span><span class="p">[:,</span> <span class="p">:]</span>
        <span class="n">bs_l_var_var</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">/=</span> <span class="n">l_var_var_scale</span>

        <span class="n">bs_variances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">bs_var_var</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">bs_l_var_var</span><span class="p">[:,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_bs_variances</span><span class="p">(</span><span class="n">bs_variances</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">y_label</span><span class="o">=</span><span class="s2">&quot;MSE of level variances estimators scaled by $V_l^2/N_l$.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Aux.plot_bs_var_log_var"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Aux.plot_bs_var_log_var">[docs]</a>    <span class="k">def</span> <span class="nf">plot_bs_var_log_var</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that  MSE of log V_l scales as variance of log chi^2_{N-1}, that is approx. 2 / (n_samples-1).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#vv = 1/ self.mlmc._variance_of_variance(self._bs_n_samples)</span>
        <span class="n">vv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_n_samples</span>
        <span class="n">bs_l_var_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_bs_level_var_variance</span><span class="p">[:,</span> <span class="p">:])</span> <span class="o">*</span> <span class="n">vv</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">bs_var_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bs_var_variance</span><span class="p">[:]</span>  <span class="c1"># - np.log(total_var_var_scale)</span>
        <span class="n">bs_variances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">bs_var_var</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">bs_l_var_var</span><span class="p">[:,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_bs_variances</span><span class="p">(</span><span class="n">bs_variances</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">y_label</span><span class="o">=</span><span class="s2">&quot;BS est. of var. of $\hat V^r$, $\hat V^r_l$ estimators.&quot;</span><span class="p">,</span>
                               <span class="p">)</span><span class="c1">#y_lim=(0.1, 20))</span></div>

    <span class="c1"># def plot_bs_var_reg_var(self):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Test that  MSE of log V_l scales as variance of log chi^2_{N-1}, that is approx. 2 / (n_samples-1).</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     vv = self.mlmc._variance_of_variance(self._bs_n_samples)</span>
    <span class="c1">#     bs_l_var_var = (self._bs_level_var_variance[:, :]) / vv[:, None]</span>
    <span class="c1">#     bs_var_var = self._bs_var_variance[:]  # - np.log(total_var_var_scale)</span>
    <span class="c1">#     bs_variances = np.concatenate((bs_var_var[None, :], bs_l_var_var[:, :]), axis=0)</span>
    <span class="c1">#     self.plot_bs_variances(bs_variances, log=True,</span>
    <span class="c1">#                            y_label=&quot;BS est. of var. of $\hat V^r$, $\hat V^r_l$ estimators.&quot;,</span>
    <span class="c1">#                            y_lim=(0.1, 20))</span>


<div class="viewcode-block" id="Aux.plot_means_and_vars"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Aux.plot_means_and_vars">[docs]</a>    <span class="k">def</span> <span class="nf">plot_means_and_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moments_mean</span><span class="p">,</span> <span class="n">moments_var</span><span class="p">,</span> <span class="n">n_levels</span><span class="p">,</span> <span class="n">exact_moments</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot means with variance whiskers to given axes.</span>
<span class="sd">        :param moments_mean: array, moments mean</span>
<span class="sd">        :param moments_var: array, moments variance</span>
<span class="sd">        :param n_levels: array, number of levels</span>
<span class="sd">        :param exact_moments: array, moments from distribution</span>
<span class="sd">        :param ex_moments: array, moments from distribution samples</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">moments_mean</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="c1"># print(&quot;moments mean &quot;, moments_mean)</span>
        <span class="c1"># print(&quot;exact momentss &quot;, exact_moments)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">moments_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mf">0.3</span>
        <span class="n">default_x</span> <span class="o">=</span> <span class="n">x</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">means</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">moments_mean</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">moments_mean</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exact_moments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">default_x</span><span class="p">,</span> <span class="n">exact_moments</span><span class="p">,</span> <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Exact moments&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">moments_mean</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">moments_var</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">colors</span><span class="p">),</span>
                             <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">LMC&quot;</span> <span class="o">%</span> <span class="n">n_levels</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ex_moments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">default_x</span> <span class="o">-</span> <span class="mf">0.125</span><span class="p">,</span> <span class="n">ex_moments</span><span class="p">,</span> <span class="s1">&#39;ko&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Exact moments&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Aux.plot_var_regression"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.Aux.plot_var_regression">[docs]</a>    <span class="k">def</span> <span class="nf">plot_var_regression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_moments</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot total and level variances and their regression and errors of regression.</span>
<span class="sd">        :param i_moments: List of moment indices to plot. If it is an int M, the range(M) is used.</span>
<span class="sd">                       If None, self.moments.size is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">moments_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">moments</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax_err</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i_moments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">i_moments</span> <span class="o">=</span> <span class="n">moments_fn</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">i_moments</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">i_moments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">i_moments</span><span class="p">))</span>
        <span class="n">i_moments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i_moments</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_moments_cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_moments_color_bar</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="n">moments_fn</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;moments&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">est_diff_vars</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">estimate_diff_vars</span><span class="p">(</span><span class="n">moments_fn</span><span class="p">)</span>
        <span class="n">reg_diff_vars</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">estimate_diff_vars_regression</span><span class="p">(</span><span class="n">moments_fn</span><span class="p">)</span> <span class="c1">#/ self.n_samples[:, None]</span>
        <span class="n">ref_diff_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref_level_var</span> <span class="c1">#/ self.n_samples[:, None]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_scatter_level_moment_data</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span>  <span class="n">ref_diff_vars</span><span class="p">,</span> <span class="n">i_moments</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scatter_level_moment_data</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">est_diff_vars</span><span class="p">,</span> <span class="n">i_moments</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="c1"># add regression curves</span>
        <span class="n">moments_x_step</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_moments</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">i_moments</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moments_cmap</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_levels</span><span class="p">)</span> <span class="o">+</span> <span class="n">moments_x_step</span> <span class="o">*</span> <span class="n">m</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">reg_diff_vars</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="n">m</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">Y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
            <span class="n">ax_err</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[:],</span> <span class="n">reg_diff_vars</span><span class="p">[:,</span> <span class="n">m</span><span class="p">]</span><span class="o">/</span><span class="n">ref_diff_vars</span><span class="p">[:,</span><span class="n">m</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;level variance $V_l$&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;step h_l&quot;</span><span class="p">)</span>

        <span class="n">ax_err</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax_err</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;regresion var. / reference var.&quot;</span><span class="p">)</span>

        <span class="c1">#ax.legend(loc=2)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;level_vars_regression.pdf&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>


<span class="c1">###########################################</span>
<span class="c1"># test.fixture.mlmc_test_run plot methods #</span>
<span class="c1">###########################################</span>

<span class="k">def</span> <span class="nf">plot_n_sample_est_distributions</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="n">total_std</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">):</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;cost&quot;</span><span class="p">)</span>
    <span class="n">cost_99</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="p">[</span><span class="mi">99</span><span class="p">])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">cost_99</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cost_99</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">total_std</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;total var&quot;</span><span class="p">)</span>
    <span class="n">tstd_99</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">total_std</span><span class="p">,</span> <span class="p">[</span><span class="mi">99</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tstd_99</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">tstd_99</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;n_samples&quot;</span><span class="p">)</span>
    <span class="n">ns_99</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="p">[</span><span class="mi">99</span><span class="p">])</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ns_99</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ns_99</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<div class="viewcode-block" id="plot_diff_var_subsample"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.plot_diff_var_subsample">[docs]</a><span class="k">def</span> <span class="nf">plot_diff_var_subsample</span><span class="p">(</span><span class="n">level_variance_diff</span><span class="p">,</span> <span class="n">n_levels</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot diff between V* and V</span>
<span class="sd">    :param level_variance_diff: array of moments sqrt(V/V*)</span>
<span class="sd">    :param n_levels: array, number of levels</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">level_variance_diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">level_variance_diff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">level_variance_diff</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">var_diff</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">LMC&quot;</span> <span class="o">%</span> <span class="n">n_levels</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">colors</span><span class="p">))</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">var_diff</span> <span class="ow">in</span>
         <span class="nb">enumerate</span><span class="p">(</span><span class="n">level_variance_diff</span><span class="p">)]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$ \sqrt{\frac</span><span class="si">{V}</span><span class="s1">{V^{*}}}$&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;moments&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># Levels on x axes</span>
        <span class="n">moments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">level_variance_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">level_variance_diff</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">level_variance_diff</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">moments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">level_variance_diff</span><span class="p">[:,</span> <span class="n">index</span><span class="p">])</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">moments</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n_levels</span><span class="p">,</span> <span class="n">moment</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">colors</span><span class="p">))</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">moment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">moments</span><span class="p">)]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$ \sqrt{\frac</span><span class="si">{V}</span><span class="s1">{V^{*}}}$&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;levels method&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;moments&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_vars"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.plot_vars">[docs]</a><span class="k">def</span> <span class="nf">plot_vars</span><span class="p">(</span><span class="n">moments_mean</span><span class="p">,</span> <span class="n">moments_var</span><span class="p">,</span> <span class="n">n_levels</span><span class="p">,</span> <span class="n">exact_moments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ex_moments</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot means with variance whiskers</span>
<span class="sd">    :param moments_mean: array, moments mean</span>
<span class="sd">    :param moments_var: array, moments variance</span>
<span class="sd">    :param n_levels: array, number of levels</span>
<span class="sd">    :param exact_moments: array, moments from distribution</span>
<span class="sd">    :param ex_moments: array, moments from distribution samples</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">moments_mean</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">moments_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mf">0.3</span>
    <span class="n">default_x</span> <span class="o">=</span> <span class="n">x</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">means</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">moments_mean</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">moments_mean</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exact_moments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">default_x</span><span class="p">,</span> <span class="n">exact_moments</span><span class="p">,</span> <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Exact moments&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">moments_mean</span><span class="p">)</span><span class="o">*</span><span class="mf">1.5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">moments_var</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">colors</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">LMC&quot;</span> <span class="o">%</span> <span class="n">n_levels</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">ex_moments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">default_x</span><span class="o">-</span><span class="mf">0.125</span><span class="p">,</span> <span class="n">ex_moments</span><span class="p">,</span> <span class="s1">&#39;ko&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Exact moments&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_convergence"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.plot_convergence">[docs]</a><span class="k">def</span> <span class="nf">plot_convergence</span><span class="p">(</span><span class="n">quantiles</span><span class="p">,</span> <span class="n">conv_val</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot convergence with moment size for various quantiles.</span>
<span class="sd">    :param quantiles: iterable with quantiles</span>
<span class="sd">    :param conv_val: matrix of ConvResult, n_quantiles x n_moments</span>
<span class="sd">    :param title: plot title and filename used to save</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">iq</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">quantiles</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">conv_val</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span>
        <span class="c1">#X = [r.size for r in results]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
        <span class="n">kl</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">kl</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">l2</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">)(</span><span class="n">iq</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">kl</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;kl_q=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;l2_q=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">title</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_diff_var"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.plot_diff_var">[docs]</a><span class="k">def</span> <span class="nf">plot_diff_var</span><span class="p">(</span><span class="n">ref_mc_diff_vars</span><span class="p">,</span> <span class="n">n_moments</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot level diff vars</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">error_power</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_moments</span><span class="p">):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="n">Y</span> <span class="o">=</span> <span class="n">ref_mc_diff_vars</span><span class="p">[:,</span> <span class="n">m</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">steps</span> <span class="o">**</span> <span class="n">error_power</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

        <span class="c1"># Y = np.percentile(self.vars_est[:, :, m],  [10, 50, 90], axis=1)</span>
        <span class="c1"># ax.plot(target_var, Y[1,:], c=color)</span>
        <span class="c1"># ax.plot(target_var, Y[0,:], c=color, ls=&#39;--&#39;)</span>
        <span class="c1"># ax.plot(target_var, Y[2, :], c=color, ls =&#39;--&#39;)</span>
        <span class="c1"># Y = (self.exact_mean[m] - self.means_est[:, :, m])**2</span>
        <span class="c1"># Y = np.percentile(Y, [10, 50, 90], axis=1)</span>
        <span class="c1"># ax.plot(target_var, Y[1,:], c=&#39;gray&#39;)</span>
        <span class="c1"># ax.plot(target_var, Y[0,:], c=&#39;gray&#39;, ls=&#39;--&#39;)</span>
        <span class="c1"># ax.plot(target_var, Y[2, :], c=&#39;gray&#39;, ls =&#39;--&#39;)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;observed var. of mean est.&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_var_regression"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.plot_var_regression">[docs]</a><span class="k">def</span> <span class="nf">plot_var_regression</span><span class="p">(</span><span class="n">ref_level_vars</span><span class="p">,</span> <span class="n">reg_vars</span><span class="p">,</span> <span class="n">n_levels</span><span class="p">,</span> <span class="n">n_moments</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot levels variance regression</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Plot variance regression for exact level variances</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_levels</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_moments</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_levels</span><span class="p">),</span>
                                                                                         <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_moments</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_levels</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_moments</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">ref_level_vars</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="p">,</span>
                <span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i_mom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_moments</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)(</span><span class="n">i_mom</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">i_mom</span><span class="p">],</span> <span class="n">reg_vars</span><span class="p">[:,</span> <span class="n">i_mom</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">1e-10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_regression_diffs"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.plot_regression_diffs">[docs]</a><span class="k">def</span> <span class="nf">plot_regression_diffs</span><span class="p">(</span><span class="n">all_diffs</span><span class="p">,</span> <span class="n">n_moments</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot level variance difference regression</span>
<span class="sd">    :param all_diffs: list, difference between Estimate._variance_regression result and Estimate.estimate_diff_var result</span>
<span class="sd">    :param n_moments: number of moments</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i_mom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_moments</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample</span><span class="p">[:,</span> <span class="n">i_mom</span><span class="p">]</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">all_diffs</span><span class="p">]</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">diffs</span><span class="p">)</span>
        <span class="n">N</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">diffs</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">L</span><span class="p">))</span> <span class="o">+</span> <span class="n">i_mom</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">diffs</span><span class="p">)</span> <span class="o">*</span> <span class="n">i_mom</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">diffs</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i_mom</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">1e-10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_mlmc_conv"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.plot_mlmc_conv">[docs]</a><span class="k">def</span> <span class="nf">plot_mlmc_conv</span><span class="p">(</span><span class="n">n_moments</span><span class="p">,</span> <span class="n">vars_est</span><span class="p">,</span> <span class="n">exact_mean</span><span class="p">,</span> <span class="n">means_est</span><span class="p">,</span> <span class="n">target_var</span><span class="p">):</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_moments</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">means_est</span><span class="p">[:,:,</span><span class="n">m</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">target_var</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>

        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">vars_est</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">m</span><span class="p">],</span>  <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">target_var</span><span class="p">,</span> <span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">target_var</span><span class="p">,</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">target_var</span><span class="p">,</span> <span class="n">Y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">ls</span> <span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="p">(</span><span class="n">exact_mean</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">means_est</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">m</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">target_var</span><span class="p">,</span> <span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">target_var</span><span class="p">,</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">target_var</span><span class="p">,</span> <span class="n">Y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">ls</span> <span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;observed var. of mean est.&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="plot_n_sample_est_distributions"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.plot_n_sample_est_distributions">[docs]</a><span class="k">def</span> <span class="nf">plot_n_sample_est_distributions</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">total_std</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">rel_moments</span><span class="p">):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plot_error</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="s2">&quot;cost err&quot;</span><span class="p">)</span>

    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plot_error</span><span class="p">(</span><span class="n">total_std</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="s2">&quot;total std err&quot;</span><span class="p">)</span>

    <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">plot_error</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="s2">&quot;n. samples err&quot;</span><span class="p">)</span>

    <span class="n">ax4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">plot_error</span><span class="p">(</span><span class="n">rel_moments</span><span class="p">,</span> <span class="n">ax4</span><span class="p">,</span> <span class="s2">&quot;moments err&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_error"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.plot_error">[docs]</a><span class="k">def</span> <span class="nf">plot_error</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">prc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="p">[</span><span class="mi">99</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">prc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">prc</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span></div>

<span class="c1"># @staticmethod</span>
<span class="c1"># def box_plot(ax, X, Y):</span>
<span class="c1">#     bp = boxplot(column=&#39;age&#39;, by=&#39;pclass&#39;, grid=False)</span>
<span class="c1">#     for i in [1, 2, 3]:</span>
<span class="c1">#         y = titanic.age[titanic.pclass == i].dropna()</span>
<span class="c1">#         # Add some random &quot;jitter&quot; to the x-axis</span>
<span class="c1">#         x = np.random.normal(i, 0.04, size=len(y))</span>
<span class="c1">#         plot(x, y, &#39;r.&#39;, alpha=0.2)</span>


<div class="viewcode-block" id="plot_pbs_flow_job_time"><a class="viewcode-back" href="../../../../mlmc.plot.html#mlmc.plot.plots.plot_pbs_flow_job_time">[docs]</a><span class="k">def</span> <span class="nf">plot_pbs_flow_job_time</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">mlmc.sample_storage_hdf</span> <span class="k">import</span> <span class="n">SampleStorageHDF</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">mlmc.tool.flow_mc</span>
    <span class="n">work_dir</span> <span class="o">=</span> <span class="s2">&quot;/home/martin/Documents/flow123d_results/flow_experiments/Exponential/corr_length_0_1/sigma_1/L50&quot;</span>
    <span class="n">sample_storage</span> <span class="o">=</span> <span class="n">SampleStorageHDF</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;mlmc_50.hdf5&quot;</span><span class="p">))</span>
    <span class="n">sample_storage</span><span class="o">.</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="mf">1e8</span>
    <span class="n">result_format</span> <span class="o">=</span> <span class="n">sample_storage</span><span class="o">.</span><span class="n">load_result_format</span><span class="p">()</span>
    <span class="n">level_params</span> <span class="o">=</span> <span class="n">sample_storage</span><span class="o">.</span><span class="n">get_level_parameters</span><span class="p">()</span>
    <span class="n">n_ops</span> <span class="o">=</span> <span class="n">sample_storage</span><span class="o">.</span><span class="n">get_n_ops</span><span class="p">()</span>
    <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
    <span class="n">level_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">level_params</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
    <span class="n">n_ops</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">n_ops</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

    <span class="n">n_elements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">level_param</span> <span class="ow">in</span> <span class="n">level_params</span><span class="p">:</span>
        <span class="n">mesh_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;l_step_</span><span class="si">{}</span><span class="s2">_common_files&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">level_param</span><span class="p">)),</span> <span class="s2">&quot;mesh.msh&quot;</span><span class="p">)</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="n">mlmc</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">flow_mc</span><span class="o">.</span><span class="n">FlowSim</span><span class="o">.</span><span class="n">extract_mesh</span><span class="p">(</span><span class="n">mesh_file</span><span class="p">)</span>
        <span class="n">n_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;ele_ids&#39;</span><span class="p">]))</span>


    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">lbls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nl</span><span class="p">)</span> <span class="k">for</span> <span class="n">nl</span> <span class="ow">in</span> <span class="n">n_elements</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">lbls</span><span class="p">)</span>
    <span class="c1">#ax.set_yscale(&#39;log&#39;)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">level_params</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">n_ops</span><span class="p">)</span>
    <span class="n">_show_and_save</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="s2">&quot;flow_time&quot;</span><span class="p">,</span> <span class="s2">&quot;flow_time&quot;</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">MLMC</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../mlmc.quantity.html">mlmc.quantity package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mlmc.html">mlmc package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Jan Brezina, Martin Spetlik.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.5.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>